name: Deploy (One-Click)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        type: choice
        required: true
        options: [staging, production]
      components:
        description: Components to deploy
        type: choice
        required: true
        default: all
        options: [all, worker, dashboard]

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ github.ref }}-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      WORKER_CONFIG: wrangler.jsonc
      DASHBOARD_CONFIG: dashboard/wrangler.container.jsonc
      D1_DATABASE_NAME: owokx_db
    steps:
      - name: Create GitHub deployment record
        id: gh_deploy
        uses: actions/github-script@f28e40c71b31f280037facc361f47a9f3d669158 # v7.1.0
        with:
          script: |
            const envName = '${{ inputs.environment }}';
            const res = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: envName,
              required_contexts: [],
              auto_merge: false,
              transient_environment: envName !== 'production',
              production_environment: envName === 'production',
              description: `Cloudflare one-click deploy (${envName})`,
            });
            core.setOutput('deployment_id', String(res.data.id));

      - name: Mark deployment in progress
        uses: actions/github-script@f28e40c71b31f280037facc361f47a9f3d669158 # v7.1.0
        with:
          script: |
            const deployment_id = Number('${{ steps.gh_deploy.outputs.deployment_id }}');
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id,
              state: 'in_progress',
              description: 'Deployment started',
            });

      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10

      - name: Verify Cloudflare credentials
        run: |
          test -n "$CLOUDFLARE_API_TOKEN"

      - name: Install worker dependencies
        run: |
          if [ -f pnpm-lock.yaml ]; then
            pnpm install --frozen-lockfile
          else
            echo "::warning::pnpm-lock.yaml missing at repository root; falling back to non-frozen install."
            pnpm install --no-frozen-lockfile
          fi

      - name: Run worker quality gates
        run: |
          pnpm run typecheck
          pnpm run test:ci
          pnpm run check

      - name: Upload worker test artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: oneclick-worker-tests-${{ inputs.environment }}-${{ github.sha }}
          path: |
            reports/**
            coverage/**
          if-no-files-found: warn

      - name: Install dashboard dependencies
        if: inputs.components == 'all' || inputs.components == 'dashboard'
        run: pnpm --dir dashboard install --frozen-lockfile

      - name: Run dashboard checks
        if: inputs.components == 'all' || inputs.components == 'dashboard'
        run: pnpm --dir dashboard run check

      - name: Verify Docker runtime
        if: inputs.components == 'all' || inputs.components == 'dashboard'
        run: docker version

      - name: Resolve deployment names
        id: names
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            echo "worker_name=owokx-production" >> "$GITHUB_OUTPUT"
            echo "dashboard_name=owokx-dashboard-production" >> "$GITHUB_OUTPUT"
          else
            echo "worker_name=owokx" >> "$GITHUB_OUTPUT"
            echo "dashboard_name=owokx-dashboard" >> "$GITHUB_OUTPUT"
          fi

      - name: Capture current Worker deployment version
        id: worker_prev
        if: inputs.components == 'all' || inputs.components == 'worker'
        env:
          SCRIPT_NAME: ${{ steps.names.outputs.worker_name }}
        run: |
          : > worker_prev_version.txt
          if npx wrangler deployments list --name "$SCRIPT_NAME" --json > worker_deployments.json; then
            node -e "const fs=require('node:fs'); const d=JSON.parse(fs.readFileSync('worker_deployments.json','utf8')); process.stdout.write(d?.[0]?.id || '');" > worker_prev_version.txt
          fi
          echo "version_id=$(cat worker_prev_version.txt)" >> "$GITHUB_OUTPUT"

      - name: Capture current dashboard deployment version
        id: dashboard_prev
        if: inputs.components == 'all' || inputs.components == 'dashboard'
        env:
          SCRIPT_NAME: ${{ steps.names.outputs.dashboard_name }}
        run: |
          : > dashboard_prev_version.txt
          if npx wrangler deployments list --name "$SCRIPT_NAME" --json > dashboard_deployments.json; then
            node -e "const fs=require('node:fs'); const d=JSON.parse(fs.readFileSync('dashboard_deployments.json','utf8')); process.stdout.write(d?.[0]?.id || '');" > dashboard_prev_version.txt
          fi
          echo "version_id=$(cat dashboard_prev_version.txt)" >> "$GITHUB_OUTPUT"

      - name: Apply D1 migrations
        if: inputs.components == 'all' || inputs.components == 'worker'
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler d1 migrations apply "$D1_DATABASE_NAME" --remote --env production --config "$WORKER_CONFIG"
          else
            npx wrangler d1 migrations apply "$D1_DATABASE_NAME" --remote --config "$WORKER_CONFIG"
          fi

      - name: Deploy Worker backend
        if: inputs.components == 'all' || inputs.components == 'worker'
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler deploy --env production --config "$WORKER_CONFIG"
          else
            npx wrangler deploy --config "$WORKER_CONFIG"
          fi

      - name: Deploy dashboard container Worker
        if: inputs.components == 'all' || inputs.components == 'dashboard'
        run: |
          if [ "${{ inputs.environment }}" = "production" ]; then
            npx wrangler deploy --env production --config "$DASHBOARD_CONFIG"
          else
            npx wrangler deploy --config "$DASHBOARD_CONFIG"
          fi

      - name: Verify deployed services
        if: success()
        env:
          COMPONENTS: ${{ inputs.components }}
          WORKER_URL: ${{ vars.OWOKX_WORKER_URL }}
          DASHBOARD_URL: ${{ vars.OWOKX_DASHBOARD_URL }}
          VERIFY_TOKEN: ${{ secrets.OWOKX_VERIFY_TOKEN }}
        run: |
          VERIFY_ARGS="--json-output deploy-verification.json"

          if [ "$COMPONENTS" = "all" ] || [ "$COMPONENTS" = "worker" ]; then
            test -n "$WORKER_URL"
            VERIFY_ARGS="$VERIFY_ARGS --worker-url $WORKER_URL"
          else
            VERIFY_ARGS="$VERIFY_ARGS --skip-worker true"
          fi

          if [ "$COMPONENTS" = "all" ] || [ "$COMPONENTS" = "dashboard" ]; then
            test -n "$DASHBOARD_URL"
            VERIFY_ARGS="$VERIFY_ARGS --dashboard-url $DASHBOARD_URL"
          else
            VERIFY_ARGS="$VERIFY_ARGS --skip-dashboard true"
          fi

          if [ -n "$VERIFY_TOKEN" ]; then
            VERIFY_ARGS="$VERIFY_ARGS --token $VERIFY_TOKEN --strict-auth true"
          fi

          node scripts/verify-deployment.mjs $VERIFY_ARGS

      - name: Generate deployment report
        if: always()
        env:
          ENVIRONMENT: ${{ inputs.environment }}
          COMPONENTS: ${{ inputs.components }}
          DEPLOYMENT_ID: ${{ steps.gh_deploy.outputs.deployment_id }}
          WORKER_NAME: ${{ steps.names.outputs.worker_name }}
          DASHBOARD_NAME: ${{ steps.names.outputs.dashboard_name }}
          WORKER_PREV_VERSION_ID: ${{ steps.worker_prev.outputs.version_id }}
          DASHBOARD_PREV_VERSION_ID: ${{ steps.dashboard_prev.outputs.version_id }}
        run: |
          node -e "const fs=require('node:fs'); const report={repo:process.env.GITHUB_REPOSITORY, sha:process.env.GITHUB_SHA, run_id:process.env.GITHUB_RUN_ID, environment:process.env.ENVIRONMENT, components:process.env.COMPONENTS, github_deployment_id:process.env.DEPLOYMENT_ID, worker_name:process.env.WORKER_NAME, dashboard_name:process.env.DASHBOARD_NAME, worker_prev_version_id:process.env.WORKER_PREV_VERSION_ID || null, dashboard_prev_version_id:process.env.DASHBOARD_PREV_VERSION_ID || null, created_at:new Date().toISOString()}; fs.writeFileSync('deploy-report.json', JSON.stringify(report, null, 2));"

      - name: Publish deployment summary
        if: always()
        env:
          COMPONENTS: ${{ inputs.components }}
          ENVIRONMENT: ${{ inputs.environment }}
          WORKER_NAME: ${{ steps.names.outputs.worker_name }}
          DASHBOARD_NAME: ${{ steps.names.outputs.dashboard_name }}
        run: |
          {
            echo "### Cloudflare Deployment Summary"
            echo ""
            echo "- Environment: $ENVIRONMENT"
            echo "- Components: $COMPONENTS"
            echo "- Worker script: $WORKER_NAME"
            echo "- Dashboard script: $DASHBOARD_NAME"
            echo "- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload deployment artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: deploy-cloudflare-${{ inputs.environment }}-${{ github.sha }}
          path: |
            deploy-report.json
            deploy-verification.json
            worker_deployments.json
            dashboard_deployments.json
          if-no-files-found: warn

      - name: Mark deployment success
        if: success()
        uses: actions/github-script@f28e40c71b31f280037facc361f47a9f3d669158 # v7.1.0
        with:
          script: |
            const deployment_id = Number('${{ steps.gh_deploy.outputs.deployment_id }}');
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id,
              state: 'success',
              description: 'Deployment succeeded',
            });

      - name: Rollback dashboard on failure
        if: failure() && (inputs.components == 'all' || inputs.components == 'dashboard') && steps.dashboard_prev.outputs.version_id && steps.dashboard_prev.outputs.version_id != ''
        env:
          SCRIPT_NAME: ${{ steps.names.outputs.dashboard_name }}
          PREV_VERSION_ID: ${{ steps.dashboard_prev.outputs.version_id }}
        run: |
          npx wrangler rollback "$PREV_VERSION_ID" --name "$SCRIPT_NAME" || true

      - name: Rollback Worker on failure
        if: failure() && (inputs.components == 'all' || inputs.components == 'worker') && steps.worker_prev.outputs.version_id && steps.worker_prev.outputs.version_id != ''
        env:
          SCRIPT_NAME: ${{ steps.names.outputs.worker_name }}
          PREV_VERSION_ID: ${{ steps.worker_prev.outputs.version_id }}
        run: |
          npx wrangler rollback "$PREV_VERSION_ID" --name "$SCRIPT_NAME" || true

      - name: Mark deployment failure
        if: failure()
        uses: actions/github-script@f28e40c71b31f280037facc361f47a9f3d669158 # v7.1.0
        with:
          script: |
            const deployment_id = Number('${{ steps.gh_deploy.outputs.deployment_id }}');
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id,
              state: 'failure',
              description: 'Deployment failed (rollback attempted)',
            });
